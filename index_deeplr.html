<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Generation Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: inline-block; width: 200px; vertical-align: top; margin-bottom: 10px; }
    select, input { width: 250px; }
    .form-group { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>Music Generation from Image</h1>
  
  <form id="uploadForm" method="post" action="/upload" enctype="multipart/form-data">
    <div class="form-group">
      <label for="file">Select an image file:</label>
      <input type="file" name="file" id="file" required>
    </div>
    
    <div class="form-group">
      <label for="length">Length (measures):</label>
      <input type="number" name="length" id="length" value="24" min="8">
    </div>
    
    <div class="form-group">
      <label for="method">Method:</label>
      <select name="method" id="method">
        <option value="dual">dual</option>
        <option value="pattern">pattern</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="pattern_name">Pattern Name:</label>
      <select name="pattern_name" id="pattern_name" disabled>
        <option value="alberti_4_4">None</option>
        <option value="alberti_4_4">alberti_4_4</option>
        <option value="boomchick_4_4">boomchick_4_4</option>
        <option value="waltz_3_4">waltz_3_4</option>
        <option value="arp_up_4_4">arp_up_4_4</option>
        <option value="ostinato_16">ostinato_16</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="left_program_index">Left Instrument:</label>
      <select name="left_program_index" id="left_program_index"></select>
    </div>
    
    <div class="form-group">
      <label for="right_program_index">Right Instrument:</label>
      <select name="right_program_index" id="right_program_index"></select>
    </div>
    
    <button type="submit">Upload & Generate</button>
  </form>
  
  <div id="resultArea" style="margin-top:20px; color:blue;"></div>
  
  <script>

    // 定义乐器字典（Instrument Name : Program Number）
    const instrumentDict = {
      "Acoustic Grand Piano": 0,
      "Bright Acoustic Piano": 1,
      "Electric Grand Piano": 2,
      "Honky-tonk Piano": 3,
      "Electric Piano 1": 4,
      "Electric Piano 2": 5,
      "Harpsichord": 6,
      "Clavinet": 7,
      "Celesta": 8,
      "Glockenspiel": 9,
      "Music Box": 10,
      "Vibraphone": 11,
      "Marimba": 12,
      "Xylophone": 13,
      "Tubular Bells": 14,
      "Dulcimer": 15,
      "Drawbar Organ": 16,
      "Percussive Organ": 17,
      "Rock Organ": 18,
      "Church Organ": 19,
      "Reed Organ": 20,
      "Accordion": 21,
      "Harmonica": 22,
      "Tango Accordion": 23,
      "Acoustic Guitar (nylon)": 24,
      "Acoustic Guitar (steel)": 25,
      "Electric Guitar (jazz)": 26,
      "Electric Guitar (clean)": 27,
      "Electric Guitar (muted)": 28,
      "Overdriven Guitar": 29,
      "Distortion Guitar": 30,
      "Guitar Harmonics": 31,
      "Acoustic Bass": 32,
      "Electric Bass (finger)": 33,
      "Electric Bass (pick)": 34,
      "Fretless Bass": 35,
      "Slap Bass 1": 36,
      "Slap Bass 2": 37,
      "Synth Bass 1": 38,
      "Synth Bass 2": 39,
      "Violin": 40,
      "Viola": 41,
      "Cello": 42,
      "Contrabass": 43,
      "Tremolo Strings": 44,
      "Pizzicato Strings": 45,
      "Orchestral Harp": 46,
      "Timpani": 47,
      "String Ensemble 1": 48,
      "String Ensemble 2": 49,
      "Synth Strings 1": 50,
      "Synth Strings 2": 51,
      "Choir Aahs": 52,
      "Voice Oohs": 53,
      "Synth Choir": 54,
      "Orchestra Hit": 55,
      "Trumpet": 56,
      "Trombone": 57,
      "Tuba": 58,
      "Muted Trumpet": 59,
      "French Horn": 60,
      "Brass Section": 61,
      "Synth Brass 1": 62,
      "Synth Brass 2": 63,
      "Soprano Sax": 64,
      "Alto Sax": 65,
      "Tenor Sax": 66,
      "Baritone Sax": 67,
      "Oboe": 68,
      "English Horn": 69,
      "Bassoon": 70,
      "Clarinet": 71,
      "Piccolo": 72,
      "Flute": 73,
      "Recorder": 74,
      "Pan Flute": 75,
      "Blown bottle": 76,
      "Shakuhachi": 77,
      "Whistle": 78,
      "Ocarina": 79,
      "Lead 1 (square)": 80,
      "Lead 2 (sawtooth)": 81,
      "Lead 3 (calliope)": 82,
      "Lead 4 (chiff)": 83,
      "Lead 5 (charang)": 84,
      "Lead 6 (voice)": 85,
      "Lead 7 (fifths)": 86,
      "Lead 8 (bass + lead)": 87,
      "Pad 1 (new age)": 88,
      "Pad 2 (warm)": 89,
      "Pad 3 (polysynth)": 90,
      "Pad 4 (choir)": 91,
      "Pad 5 (bowed)": 92,
      "Pad 6 (metallic)": 93,
      "Pad 7 (halo)": 94,
      "Pad 8 (sweep)": 95,
      "FX 1 (rain)": 96,
      "FX 2 (soundtrack)": 97,
      "FX 3 (crystal)": 98,
      "FX 4 (atmosphere)": 99,
      "FX 5 (brightness)": 100,
      "FX 6 (goblins)": 101,
      "FX 7 (echoes)": 102,
      "FX 8 (sci-fi)": 103,
      "Sitar": 104,
      "Banjo": 105,
      "Shamisen": 106,
      "Koto": 107,
      "Kalimba": 108,
      "Bagpipe": 109,
      "Fiddle": 110,
      "Shanai": 111,
      "Tinkle Bell": 112,
      "Agogo": 113,
      "Steel Drums": 114,
      "Woodblock": 115,
      "Taiko Drum": 116,
      "Melodic Tom": 117,
      "Synth Drum": 118,
      "Reverse Cymbal": 119,
      "Guitar Fret Noise": 120,
      "Breath Noise": 121,
      "Seashore": 122,
      "Bird Tweet": 123,
      "Telephone Ring": 124,
      "Helicopter": 125,
      "Applause": 126,
      "Gunshot": 127
    };

    // 填充左声部和右声部的下拉菜单
    function populateInstrumentSelect(selectId, defaultName) {
      const selectElem = document.getElementById(selectId);
      for (const [name, prog] of Object.entries(instrumentDict)) {
        const option = document.createElement("option");
        option.value = prog;
        option.text = name;
        selectElem.appendChild(option);
      }
      // 设置默认选中项
      selectElem.value = instrumentDict[defaultName];
    }

    // 仅当 method=="pattern" 时，pattern_name select 可用
    document.getElementById("method").addEventListener("change", function() {
      const method = this.value;
      const patternSelect = document.getElementById("pattern_name");
      if (method === "pattern") {
        patternSelect.disabled = false;
      } else {
        patternSelect.disabled = true;
      }
    });

    // 页面加载时填充两个乐器选择下拉菜单
    window.addEventListener("DOMContentLoaded", () => {
      populateInstrumentSelect("left_program_index", "Acoustic Bass");
      populateInstrumentSelect("right_program_index", "Acoustic Grand Piano");
    });

    // 假设上传接口返回的 JSON 格式：
    // {
    //   "success": true,
    //   "pngFiles": [ [ "url1", "url2" ], [ "url3", "url4" ] ],
    //   "mp3Files": [ "mp3_url1", "mp3_url2" ],
    //   "pdfFiles": [ "pdf_url1" ]
    // }
    let mp3Files = [];
    let pngFiles = [];
    let pdfFiles = [];

    const BACKEND_URL = "https://blossound-production.up.railway.app";
    // const BACKEND_URL = "http://localhost:8080";

    function displaySet(index) {
        const displaySection = document.getElementById("resultArea");
        displaySection.innerHTML = ""; // 清空之前的内容

        // 显示 MP3 播放器
        if (mp3Files[index]) {
            // 使用 fetch 加载 MIDI 文件（这里假设 mp3Files[index] 实际上是 .mid 文件的 URL）
            fetch(mp3Files[index])
                .then(response => response.arrayBuffer())
                .then(data => {
                // 利用 Tonejs/Midi 解析 MIDI 数据
                const midi = new Tone.Midi(data);
                
                // 创建一个 Tone.Sampler 使用 Salamander 采样库
                const sampler = new Tone.Sampler({
                    urls: {
                    "A0": "A0.mp3",
                    "C1": "C1.mp3",
                    "D#1": "Ds1.mp3",
                    "F#1": "Fs1.mp3",
                    "A1": "A1.mp3",
                    "C2": "C2.mp3",
                    "D#2": "Ds2.mp3",
                    "F#2": "Fs2.mp3",
                    "A2": "A2.mp3",
                    "C3": "C3.mp3",
                    "D#3": "Ds3.mp3",
                    "F#3": "Fs3.mp3",
                    "A3": "A3.mp3",
                    "C4": "C4.mp3",
                    "D#4": "Ds4.mp3",
                    "F#4": "Fs4.mp3",
                    "A4": "A4.mp3",
                    "C5": "C5.mp3",
                    "D#5": "Ds5.mp3",
                    "F#5": "Fs5.mp3",
                    "A5": "A5.mp3",
                    "C6": "C6.mp3",
                    "D#6": "Ds6.mp3",
                    "F#6": "Fs6.mp3",
                    "A6": "A6.mp3",
                    "C7": "C7.mp3",
                    "D#7": "Ds7.mp3",
                    "F#7": "Fs7.mp3",
                    "A7": "A7.mp3",
                    "C8": "C8.mp3"
                    },
                    release: 1,
                    baseUrl: "https://tonejs.github.io/audio/salamander/"
                }).toDestination();
                
                // 开始播放前先启动 Tone.Transport
                Tone.Transport.start();
                
                // 获取当前时间，稍微延迟以确保所有采样加载完成
                const now = Tone.now() + 0.5;
                
                // 遍历所有 MIDI 轨道和音符，并安排采样器播放
                midi.tracks.forEach(track => {
                    track.notes.forEach(note => {
                    // note.name 为标准乐谱名称（例如 "C4"），note.duration 为时值，note.time 为起始时间
                    sampler.triggerAttackRelease(note.name, note.duration, note.time + now, note.velocity);
                    });
                });
            
            })
            .catch(error => {
            console.error("Error loading MIDI:", error);
            });
        }

        // 显示乐谱图片
        if (pngFiles[1 - index]) {
        const images = Array.isArray(pngFiles[1 - index]) ? pngFiles[1 - index] : [pngFiles[1 - index]];
        const container = document.createElement("div");
        container.className = "image-container";
        images.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Score Image";
        container.appendChild(img);
        });
        displaySection.appendChild(container);
        }

        
        // 显示 PDF 链接
        if (pdfFiles.length > 0) {
        const pdfLink = document.createElement("a");
        pdfLink.href = pdfFiles[0];
        pdfLink.target = "_blank";
        pdfLink.innerText = "Open generated PDF";
        pdfLink.style.display = "block";
        pdfLink.style.marginTop = "10px";
        displaySection.appendChild(pdfLink);
        }
    }

    // 处理表单提交，保存返回的结果数据，并显示单个按钮
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
            method: "POST",
            body: formData
        });
        const result = await response.json();
        if(result.success) {
            document.getElementById("resultArea").innerText = "Generation success!";
            mp3Files = result.mp3Files || [];
            pngFiles = result.pngFiles || [];
            pdfFiles = result.pdfFiles || [];
            
            // 创建一个单独的按钮来显示结果
            const btn = document.createElement("button");
            btn.innerText = "Show Output";
            btn.addEventListener("click", () => displaySet(0));
            const resultArea = document.getElementById("resultArea");
            resultArea.innerHTML = "";  // 清除文本提示
            resultArea.appendChild(btn);
        } else {
            document.getElementById("resultArea").innerText = "Error: " + (result.error || "Unknown error");
        }
        } catch(err) {
        console.error("Fetch error:", err);
        document.getElementById("resultArea").innerText = "Request failed: " + err;
        }

        });
  </script>
</body>
</html>