<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Generation Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tone.js & MIDI解析库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body {
        font-family: 'Avenir';
        background-color: #FCFAF2;
        color: #080808;
        margin: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;  /* 垂直居中 */
        align-items: center;      /* 水平居中 */
        min-height: 100vh;        /* 至少占满整个视口高度 */
        text-align: center;       /* 文字居中 */
    }
    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 40px);
      width: 100%;
    }
    .content {
      flex: 1;
      padding: 40px 20px 20px 20px;
    }
    /* footer 固定在页面最下方 */
    footer {
        margin-top: auto;  /* 自动填充顶部空间，将 footer 推到底部 */
        width: 100%;
        text-align: center;
        font-size: 9px;
        color: #555;
        padding: 10px 0;
    }
    /* 导航侧边栏样式 */
    #sidebar {
      font-family: 'Avenir';
      height: calc(100vh - 40px);
      width: 250px;
      position: fixed;
      left: -270px;
      top: 0;
      background-color: #434343;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
      z-index: 2;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      padding-bottom: 60px;  /* 例如底部再增加40px内边距 */
    }
    /* 上半部分导航 */
    .nav-top ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    /* 下半部分导航 */
    .nav-bottom {
      margin-top: auto;  /* 将 nav-bottom 推到最底部 */
      margin-bottom: 60px;  /* 在底部再留出20px的间距 */
    }

    .nav-bottom ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    /* 设置 contact 项的字体较小 */
    .nav-bottom ul li.contact a {
      font-size: 0.7em;  /* 例如 70% 的默认字号 */
    }
    #sidebar ul {
      list-style-type: none;
      padding: 0;
    }
    #sidebar ul li {
      padding: 8px 8px 8px 32px;
      text-align: left;
    }
    #sidebar ul li a {
      color: #fff;
      text-decoration: none;
      display: block;
    }
    #sidebar ul li a:hover {
      background-color: #434343;
    }
    #openSidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 30px;
      background: none;
      border: none;
      color: #434343;
      cursor: pointer;
      z-index: 3;
    }
    #closeSidebar {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 36px;
      background: none;
      border: none;
      color: #FCFAF2;
      cursor: pointer;
    }
    .container {
      display: flex;
      justify-content: space-between; /* 确保左侧和右侧有间距 */
      align-items: flex-start; /* 让两个部分的顶部对齐 */
      flex-wrap: wrap; /* ❌ 避免 flex 自动换行 */
      gap: 0; /* 左右两部分的间距 */
      width: 100%; /* 确保足够的可用空间 */
    }
    /* 左侧内容（表单 + 结果） */
    .left-section {
      flex: 1; /* 让左侧部分自动适应 */
      min-width: 400px;
    }
    #uploadForm {
        width: 100%; /* 让 form 充满 container */
    }
    .image-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      overflow-x: auto;
      padding: 10px;
    }
    .image-container img {
      background-color: white;
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      clip-path: inset(0 round 8px);
    }
    .midi-file-block {
      margin-bottom: 10px;
    }
    .midi-file-block button {
      margin-right: 10px;
    }
    /* 隐藏文件输入框（移出视口） */
    #imageUpload {
      position: absolute;
      left: -9999px;
    }
    .custom-file-upload {
      font-family: 'Avenir';
      display: inline-block;
      width: 150px;      /* 固定宽度 */
      height: 50px;      /* 固定高度 */
      line-height: 50px; /* 设置行高，使文字垂直居中 */
      text-align: center;/* 文字水平居中 */
      padding: 0;        /* 如果设置了固定高度，通常需要取消内边距 */
      cursor: pointer;
      border: 2px solid #074D8F;
      border-radius: 8px;
      background-color: #074D8F;
      color: #fff;
      font-size: 16px;
      transition: background-color 0.3s, border-color 0.3s;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      margin-top: 5px; /* 避免与侧边栏按钮重叠 */
      margin-right: 50px;
      margin-left: 50px;
    }
    .custom-file-upload:hover {
      background-color: #3A8Fb7;
    }
    .btn {
      font-family: 'Avenir';
      display: inline-block;
      width: 150px;      /* 固定宽度 */
      height: 50px;      /* 固定高度 */
      line-height: 50px; /* 设置行高，使文字垂直居中 */
      text-align: center;/* 文字水平居中 */
      padding: 0;        /* 如果设置了固定高度，通常需要取消内边距 */
      cursor: pointer;
      border: 2px solid #434343;
      border-radius: 8px;
      background-color: #434343;
      color: #fff;
      font-size: 16px;
      margin-right: 50px;
      margin-top: 5px;
      margin-left: 50px;
      transition: background-color 0.3s, border-color 0.3s;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    }
    .btn:hover {
      background-color: #89916B;
    }
    #right_program_index {
    font-family: 'Avenir', sans-serif;
    }

    /* 弹出框（Modal）样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      width: 400px;
      height: 600px;
      background-color: #fff;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px; /* 无圆角 */
      padding: 20px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .modal-content .scrollContainer {
      font-size: 14px;
      overflow-y: auto;
      flex: 1;
      text-align: left;
    }
    .modal-content p {
      margin: 5px 0;
    }
    .modal-content .centerContent {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 14px;
    }
    .modal-content .close {
      position: absolute;
      top: 14px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
    }
    /* 预览区域样式 */
    #previewArea {
      margin-top: 20px;
      text-align: center;
    }
    #previewArea p {
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
    }
    #previewArea img {
      width: 100px;
      height: auto;
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    /* 让整个表单区域整齐 */
  .form-container {
      width: 400px; /* 适当设置宽度 */
      margin: 20px auto; /* 居中 */
      padding: 20px;
      border-radius: 10px;
      background-color: #f9f9f9;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
  }

  /* 统一 div 使其垂直对齐 */
  .form-container div {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 10px;
  }

  /* label 统一样式 */
  .form-container label {
      color: #1C1C1C;
      /* font-weight: bold;*/
      font-family: 'Avenir', sans-serif;
      width: 150px; /* 让 label 统一宽度 */
      text-align: right; /* 让 label 右对齐 */
      padding-right: 20px;
  }

  /* 输入框、下拉框的样式 */
  .form-container input,
  .form-container select {
      width: 220px; /* 让输入框和下拉框对齐 */
      padding: 5px;
      border: 1px solid #074D8F;
      border-radius: 5px;
      font-size: 14px;
      font-family: 'Avenir', sans-serif;
  }

  /* 让禁用的下拉框稍微灰色 */
  .form-container select:disabled {
      background-color: #ddd;
      color: #666;
  }

  /* 让 select 选项的字体也统一 */
  .form-container select option {
      font-family: 'Avenir', sans-serif;
  }

  /* 鼠标悬停时的效果 */
  .form-container input:hover,
  .form-container select:hover {
      border-color: #05376D;
      background-color: #eef5ff;
  }


  #visualOutputDiv {
    display: flex;
    flex-direction: column; /* 让内容垂直排列 */
    min-width: 300px;
    max-width: 50%; /* 避免太宽 */
    padding: 0;
    align-items: center; /* 让所有内容居中 */
    justify-content: center;
  }
  /* 当 #visualOutputDiv 为空时，强制 .left-section 占据整个父容器 */
  #visualOutputDiv:empty {
      display: none;
  }
  #visualOutputDiv:empty + .left-section {
    grid-column: span 2; /* 让它独占整个行 */
    justify-self: center;
  }
  
  .pdf-btn {
    font-family: 'Avenir';
    display: inline-block;
    width: 150px;      /* 固定宽度 */
    height: 50px;      /* 固定高度 */
    line-height: 50px; /* 设置行高，使文字垂直居中 */
    text-align: center; /* 文字水平居中 */
    padding: 0;         /* 取消内边距，避免影响布局 */
    cursor: pointer;
    text-decoration: none; /* 移除超链接默认下划线 */
    color: #1C1C1C; /* ✅ 文字颜色 */
    font-size: 16px;

    margin-right: 50px;
    margin-bottom: 5px;
    margin-left: 50px;
    transition: color 0.3s; /* 只在颜色变化时添加过渡动画 */
    border: none; /* ✅ 去除边框 */
    background-color: transparent; /* ✅ 透明背景 */
    box-shadow: none; /* ✅ 去除阴影 */
}

/* 鼠标悬停时可以增加颜色变化 */
.pdf-btn:hover {
    color: #4D5139; /* ✅ 悬停时颜色变化（可选） */
    text-decoration: underline; /* ✅ 可选：悬停时添加下划线 */
}

      /* 针对屏幕宽度较小的设备进行调整 */
      @media only screen and (max-width: 800px) {
      body {
        font-size: 18px; /* 增大整体文字大小 */
        margin: 0;
        padding: 0;
        width: 100vw;
        overflow-x: hidden; /* 防止横向滚动条 */
      }
      .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }
      .container {
        display: flex;
        flex-direction: column; /* ✅ 在小屏幕时改成纵向排列 */
        align-items: center; /* ✅ 让子元素居中 */
        justify-content: center; /* ✅ 让内容在容器内居中 */
        text-align: center; /* ✅ 确保文本居中 */
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }
      .modal-content {
        width: calc(100vw - 100px); /* 手机屏幕宽度减去100px */
        height: 600px;
      }
      .btn {
        margin: 10px 20px;    /* 调整按钮的外边距 */
      }
      .custom-file-upload {
        margin: 10px 20px;    /* 调整按钮的外边距 */
      }
      .image-container {
        justify-content: flex-start; /* 屏幕较窄时，从左侧排列 */
      }
      .image-container img {
        width: calc(100vw - 50px);
      }
      #sidebar {
        height: calc(100vh - 40px);
        padding-bottom: 100px;  /* 减少内边距 */
        /* 如果内容太多，也可以添加滚动条 */
        overflow-y: auto;
      }
      /* 调整底部导航的外边距 */
      .nav-bottom {
        margin-top: auto;  /* 保持推到底部 */
        margin-bottom: 200px;  /* 减少底部留白 */
      }
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        z-index: 100;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- 侧边栏 -->
  <div id="sidebar">
    <button id="closeSidebar">&times;</button>
    <div class="nav-top">
      <ul>
        <li><a href="#" id="nav-top">TOP</a></li>
        <li><a href="index.html" id="nav-blossound"><b>Blossound</b></a></li>
        <li><a href="index_unseen.html" id="nav-unseen"><b>Unseen Rhapsody</b></a></li>
      </ul>
    </div>
    <div class="nav-bottom">
      <ul>
        <li class="contact"><a href="#" id="nav-contact">Contact Us</a></li>
        <li class="contact"><a href="#" id="nav-faq">FAQ</a></li>
        <li class="contact"><a href="#" id="nav-future">Future Visions</a></li>
      </ul>
    </div>
  </div>
  <button id="openSidebar">&#9776;</button>



  <div class="content">
  <h1>Blossound</h1>
  <p>Hearing the colors unseen</p>

  <div class="container">
    <div class="left-section">
    <form id="uploadForm" method="post" action="/upload" enctype="multipart/form-data">
      <div>
        <!--
        <label for="file" style="color: #074D8F;"><b>Select an image</b></label>
        <input type="file" name="file" id="file" style="font-family: 'Avenir';" required>
        -->
        <label for="imageUpload" class="custom-file-upload">
          <b>SELECT IMAGE</b>
        </label>
        <input type="file" id="imageUpload" accept="image/*" / name="file" required>

        <div id="previewArea"></div>
        
      </div>

      <div class="form-container">
      <div>
        <label for="length">Num of Measures</label>
        <!--<input type="number" name="length" id="length" value="24" min="8"> -->
        <select name="length" id="length">
          <!-- 生成从 8 到 32 的选项 -->
          <script>
              const lengthSelect = document.getElementById("length");
              for (let i = 8; i <= 32; i++) {
                  let option = document.createElement("option");
                  option.value = i;
                  option.textContent = i;
                  if (i === 24) option.selected = true; // 默认选中 24
                  lengthSelect.appendChild(option);
              }
          </script>
      </select>
      </div>
      <div>
        <label for="method">Method</label>
        <select name="method" id="method">
          <option value="dual">dual</option>
          <option value="pattern">pattern</option>
        </select>
      </div>
      <div>
        <label for="pattern_name"">Pattern Name</label>
        <select name="pattern_name" id="pattern_name" disabled>
          <option value="alberti_4_4">alberti_4_4</option>
          <option value="boomchick_4_4">boomchick_4_4</option>
          <option value="waltz_3_4">waltz_3_4</option>
          <option value="arp_up_4_4">arp_up_4_4</option>
          <option value="ostinato_16">ostinato_16</option>
        </select>
      </div>
      <div>
        <label for="left_program_index">Left Instrument</label>
        <select name="left_program_index" id="left_program_index"></select>
      </div>
      <div>
        <label for="right_program_index">Right Instrument</label>
        <select name="right_program_index" id="right_program_index"></select>
      </div>
    </div>
      <button type="submit" class="btn"><b>GENERATE</b></button>
    </form>

  
  <!-- 用于显示生成成功或错误信息 -->
  <div id="resultArea" style="margin-top:20px; color:#1C1C1C;"></div>
</div>  <!--left section-->

  <!-- 用于显示可视化输出 -->
  <div id="visualOutputDiv"></div>
  <br><br><br>
</div> <!--container-->

  <footer>
    © 2025 Blossound. All rights reserved.
  </footer>
</div> <!--content-->

<!-- 弹出框 -->
<div id="modal" class="modal">
  <div class="modal-content">
  </div>
</div>

</div> <!--wrapper-->
  
  <script>
    /* 导航侧边栏的开关 */
    const openSidebar = document.getElementById('openSidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    const sidebar = document.getElementById('sidebar');
    
    openSidebar.addEventListener('click', () => {
      sidebar.style.left = "0";
    });
    
    closeSidebar.addEventListener('click', () => {
      sidebar.style.left = "-250px";
    });
    
    /* 弹出框功能 */
    const modal = document.getElementById('modal');
    const modalContentContainer = document.querySelector('.modal-content');
    
    function openModal() {
      modal.style.display = "flex";
    }
    
    function closeModal() {
      modal.style.display = "none";
    }
    
    // 关闭按钮事件（需在每次设置内容后绑定）
  function bindModalClose() {
    document.getElementById('modalClose').addEventListener('click', closeModal);
  }
  
  // 当点击 TOP 时，显示三段长文本，文字字号10px，内容可滚动
  document.getElementById('nav-top').addEventListener('click', (e) => {
    e.preventDefault();
    modalContentContainer.innerHTML =
      '<span class="close" id="modalClose">&times;</span>' +
      '<div class="scrollContainer">' +
        '<h2>INTRODUCTION</h2><br>' +
        '<p>Have you ever stood in a museum or art exhibition, gazing at a masterpiece yet feeling unable to truly enter the artist’s world—perhaps due to a language barrier? Or maybe you’ve wanted to bring your parents or friends along, only to realize some are visually impaired and can only listen to others describe the beauty they cannot see for themselves? Wouldn’t it be wonderful if we could transform images into <strong>sound</strong>, allowing our eyes and ears to discover the wonders of art together?</p><br><br>' +
        '<p>With these thoughts in mind, I had a bold idea: what if we could interpret images through music, letting the colors and emotions of a painting blossom into a melody in our minds? Could this enable visually impaired individuals to <strong>hear</strong> the essence of a painting, while giving all of us a deeper understanding of the work? Driven by this question, I created a small <strong>image-to-sound</strong> project. Simply upload a photo, and the system automatically generates a unique piano melody and score—bestowing each still image with its own <strong>background song</strong>.</p><br><br>' +
        '<p>To give you a taste of this cross-boundary exploration:</p><br><br>' +
        '<p>I.   Photos taken at the same place, but in different seasons or weather, might translate into completely distinct sets of notes—allowing you to <strong>hear</strong> the contrast between the vitality of spring and the melancholy of autumn.</p><br>' +
        '<p>II.  In a museum, a Monet or Van Gogh painting could be rendered into a melody, so you can <strong>hear</strong> its colors while admiring the brushstrokes.</p><br>' +
        '<p>III. Traveling with family or friends? Snap a memorable photo, then instantly generate a <strong>spontaneous photo soundtrack</strong>, preserving both the image and its music as a one-of-a-kind memento.</p><br>' +
        '<p>I hope this <strong>sonic visualization</strong> approach will offer a fresh perspective for more people to appreciate art, especially those who may not be able to see it themselves. And for those with no composition experience, this project might reveal how a single photograph can inspire a marvelous musical connection. Every click of the shutter is like the world searching for its theme song. May you find, in this project, a chance to hear the distinct tune that belongs to both you and the image before you?</p><br><br>' +
      '</div>';
    bindModalClose();
    openModal();
  });
  
  // 当点击 Contact Us 时，弹出框中显示 “e-mail address”
  document.getElementById('nav-contact').addEventListener('click', (e) => {
    e.preventDefault();
    modalContentContainer.innerHTML =
      '<span class="close" id="modalClose">&times;</span>' +
      '<div class="scrollContainer">' +
        '<h2>CONTACT BLOSSOUND</h2>' +
        '<p><i>Where Colors Find Their Voice</i></p><br><br>' +
        '<p>We believe every image holds a hidden melody waiting to be heard. Whether you’re an artist exploring sonic landscapes, a museum curator reimagining accessibility, or simply someone who just saw a sunset that deserves its own soundtrack – we want to hear from you.</p><br><br><br><br>' + 
        '<p><strong>Let’s Create Harmony Together:</strong></p>' +
        '<p><i>General Inquires</i>: yaoyao.demi0420@gmail.com</p>' +
        '<p>We read every message and respond within 72 hours.</p><br><br>' +
        '<p align="center">"<i>The world whispers in colors, <br>and we’re here to amplify their song.</i>"</p><br><br>' +
      '</div>';
    bindModalClose();
    openModal();
  });
  
  // 当点击 FAQ 时，弹出框中显示 “Answers”
  document.getElementById('nav-faq').addEventListener('click', (e) => {
    e.preventDefault();
    modalContentContainer.innerHTML =
      '<span class="close" id="modalClose">&times;</span>' +
      '<div class="centerContent">' +
        '<p>We will collect questions and list the answers here.</p>' +
      '</div>';
    bindModalClose();
    openModal();
  });

    // 当点击 FAQ 时，弹出框中显示 “Answers”
    document.getElementById('nav-future').addEventListener('click', (e) => {
    e.preventDefault();
    modalContentContainer.innerHTML =
      '<span class="close" id="modalClose">&times;</span>' +
      '<div class="scrollContainer">' +
        '<h2>Towards Unseen Rhapsody</h2>' +
        '<p><i>Hearing the colors unseen</i></p><br><br>' +
        '<p>At Blossound, we’re crafting a world where art transcends the boundaries of light. We are currently:</p><br>' + 
        '<p>I.  Developing haptic-sound interfaces that empower fingertips to see melodies</p><br>' +
        '<p>II. Co-creating immersive, multi-sensory gallery experiences with blind musicians.</p><br><br>' +
      '</div>';
    bindModalClose();
    openModal();
  });
  
  // 点击弹出框背景关闭弹出框
  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

    // 监听文件选择的 change 事件
    document.getElementById("imageUpload").addEventListener("change", function() {
      // 清空结果区域
      document.getElementById("resultArea").innerHTML = "";
      // 清空可视化输出区域
      document.getElementById("visualOutputDiv").innerHTML = "";
    });
    // 全局变量
    let midFiles = [];  // 存放 .mid 文件 URL（后端返回）
    let pngFiles = [];  // 存放 PNG 图片 URL
    let pdfFiles = [];  // 存放 PDF 文件 URL

    // Tone.js 调度用
    let midiPlayer = null;  // 当前调度的事件 ID 数组
    let isPlaying = false;   // 当前是否正在播放 MIDI

    // const BACKEND_URL = "http://localhost:8080";
    const BACKEND_URL = "https://blossound-production.up.railway.app";

    // 乐器映射表
    const instrumentDict = {
      "Acoustic Grand Piano": 0,
      "Bright Acoustic Piano": 1,
      "Electric Grand Piano": 2,
      "Honky-tonk Piano": 3,
      "Electric Piano 1": 4,
      "Electric Piano 2": 5,
      "Harpsichord": 6,
      "Clavinet": 7,
      "Celesta": 8,
      "Glockenspiel": 9,
      "Music Box": 10,
      "Vibraphone": 11,
      "Marimba": 12,
      "Xylophone": 13,
      "Tubular Bells": 14,
      "Dulcimer": 15,
      "Drawbar Organ": 16,
      "Percussive Organ": 17,
      "Rock Organ": 18,
      "Church Organ": 19,
      "Reed Organ": 20,
      "Accordion": 21,
      "Harmonica": 22,
      "Tango Accordion": 23,
      "Acoustic Guitar (nylon)": 24,
      "Acoustic Guitar (steel)": 25,
      "Electric Guitar (jazz)": 26,
      "Electric Guitar (clean)": 27,
      "Electric Guitar (muted)": 28,
      "Overdriven Guitar": 29,
      "Distortion Guitar": 30,
      "Guitar Harmonics": 31,
      "Acoustic Bass": 32,
      "Electric Bass (finger)": 33,
      "Electric Bass (pick)": 34,
      "Fretless Bass": 35,
      "Slap Bass 1": 36,
      "Slap Bass 2": 37,
      "Synth Bass 1": 38,
      "Synth Bass 2": 39,
      "Violin": 40,
      "Viola": 41,
      "Cello": 42,
      "Contrabass": 43,
      "Tremolo Strings": 44,
      "Pizzicato Strings": 45,
      "Orchestral Harp": 46,
      "Timpani": 47,
      "String Ensemble 1": 48,
      "String Ensemble 2": 49,
      "Synth Strings 1": 50,
      "Synth Strings 2": 51,
      "Choir Aahs": 52,
      "Voice Oohs": 53,
      "Synth Choir": 54,
      "Orchestra Hit": 55,
      "Trumpet": 56,
      "Trombone": 57,
      "Tuba": 58,
      "Muted Trumpet": 59,
      "French Horn": 60,
      "Brass Section": 61,
      "Synth Brass 1": 62,
      "Synth Brass 2": 63,
      "Soprano Sax": 64,
      "Alto Sax": 65,
      "Tenor Sax": 66,
      "Baritone Sax": 67,
      "Oboe": 68,
      "English Horn": 69,
      "Bassoon": 70,
      "Clarinet": 71,
      "Piccolo": 72,
      "Flute": 73,
      "Recorder": 74,
      "Pan Flute": 75,
      "Blown bottle": 76,
      "Shakuhachi": 77,
      "Whistle": 78,
      "Ocarina": 79,
      "Lead 1 (square)": 80,
      "Lead 2 (sawtooth)": 81,
      "Lead 3 (calliope)": 82,
      "Lead 4 (chiff)": 83,
      "Lead 5 (charang)": 84,
      "Lead 6 (voice)": 85,
      "Lead 7 (fifths)": 86,
      "Lead 8 (bass + lead)": 87,
      "Pad 1 (new age)": 88,
      "Pad 2 (warm)": 89,
      "Pad 3 (polysynth)": 90,
      "Pad 4 (choir)": 91,
      "Pad 5 (bowed)": 92,
      "Pad 6 (metallic)": 93,
      "Pad 7 (halo)": 94,
      "Pad 8 (sweep)": 95,
      "FX 1 (rain)": 96,
      "FX 2 (soundtrack)": 97,
      "FX 3 (crystal)": 98,
      "FX 4 (atmosphere)": 99,
      "FX 5 (brightness)": 100,
      "FX 6 (goblins)": 101,
      "FX 7 (echoes)": 102,
      "FX 8 (sci-fi)": 103,
      "Sitar": 104,
      "Banjo": 105,
      "Shamisen": 106,
      "Koto": 107,
      "Kalimba": 108,
      "Bagpipe": 109,
      "Fiddle": 110,
      "Shanai": 111,
      "Tinkle Bell": 112,
      "Agogo": 113,
      "Steel Drums": 114,
      "Woodblock": 115,
      "Taiko Drum": 116,
      "Melodic Tom": 117,
      "Synth Drum": 118,
      "Reverse Cymbal": 119,
      "Guitar Fret Noise": 120,
      "Breath Noise": 121,
      "Seashore": 122,
      "Bird Tweet": 123,
      "Telephone Ring": 124,
      "Helicopter": 125,
      "Applause": 126,
      "Gunshot": 127
    };

    let sampler = null;
    let samplerLoaded = false;

    async function initSampler() {
        // 解锁音频上下文（需用户交互，如果此时还没有，可以在第一次点击时调用）
        await Tone.start();
        console.log("AudioContext unlocked.");

        // 创建 Sampler 一次
        sampler = new Tone.Sampler(
        {
            "A0": "A0.mp3",
            "C1": "C1.mp3",
            "D#1": "Ds1.mp3",
            "F#1": "Fs1.mp3",
            "A1": "A1.mp3",
            "C2": "C2.mp3",
            "D#2": "Ds2.mp3",
            "F#2": "Fs2.mp3",
            "A2": "A2.mp3",
            "C3": "C3.mp3",
            "D#3": "Ds3.mp3",
            "F#3": "Fs3.mp3",
            "A3": "A3.mp3",
            "C4": "C4.mp3",
            "D#4": "Ds4.mp3",
            "F#4": "Fs4.mp3",
            "A4": "A4.mp3",
            "C5": "C5.mp3",
            "D#5": "Ds5.mp3",
            "F#5": "Fs5.mp3",
            "A5": "A5.mp3",
            "C6": "C6.mp3",
            "D#6": "Ds6.mp3",
            "F#6": "Fs6.mp3",
            "A6": "A6.mp3",
            "C7": "C7.mp3",
            "D#7": "Ds7.mp3",
            "F#7": "Fs7.mp3",
            "A7": "A7.mp3",
            "C8": "C8.mp3"
        },
        {
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/",
            onload: () => {
            console.log("Global Sampler loaded!");
            samplerLoaded = true;
            }
        }
        ).toDestination();
    }

    // 注册一次性的用户交互事件（点击页面任意位置即可触发 initSampler）
    document.addEventListener('click', initSampler, { once: true });


    /* 自动显示图片预览 */
    const imageUpload = document.getElementById("imageUpload");
    const previewArea = document.getElementById("previewArea");
    
    imageUpload.addEventListener("change", function() {
      if (this.files && this.files[0]) {
        // 清除之前的预览
        previewArea.innerHTML = "";
        const message = document.createElement("p");
        message.textContent = "Image uploaded!";
        previewArea.appendChild(message);
        
        const img = document.createElement("img");
        img.src = URL.createObjectURL(this.files[0]);
        previewArea.appendChild(img);
        
        // 图片加载完毕后释放内存
        img.onload = () => {
          URL.revokeObjectURL(img.src);
        };
      }
    });

    // 填充乐器下拉菜单
    function populateInstrumentSelect(selectId, defaultName) {
      const selectElem = document.getElementById(selectId);
      for (const [name, prog] of Object.entries(instrumentDict)) {
        const option = document.createElement("option");
        option.value = prog;
        option.text = name;
        selectElem.appendChild(option);
      }
      // 如果存在默认乐器名，则选中它
      if (instrumentDict[defaultName] !== undefined) {
        selectElem.value = instrumentDict[defaultName];
      }
    }

    // 切换 method 时启用/禁用 pattern_name 下拉菜单
    document.getElementById("method").addEventListener("change", function() {
      const patternSelect = document.getElementById("pattern_name");
      patternSelect.disabled = (this.value !== "pattern");
    });

    // 页面加载时填充乐器选择菜单
    window.addEventListener("DOMContentLoaded", () => {
      populateInstrumentSelect("left_program_index", "Acoustic Bass");
      populateInstrumentSelect("right_program_index", "Acoustic Grand Piano");
    });

    // 播放某个 MID 文件
    async function playMidi(index) {
    // 如果还没加载完 Sampler，直接返回或者提示
    if (!samplerLoaded) {
        console.error("Sampler not loaded yet!");
        return;
    }

    // 如果没URL或者已经在播
    if (!midFiles[index]) {
        console.error("没有对应的 MID 文件 URL");
        return;
    }
    if (isPlaying && midiPlayer) {
        stopMidi(); // 先停止上一次
    }

    try {
        // 拉取并解析 MIDI
        const response = await fetch(midFiles[index]);
        const data = await response.arrayBuffer();
        const midi = new Midi(data);

        // 重置 Transport
        Tone.Transport.cancel();
        Tone.Transport.stop();
        Tone.Transport.position = 0;
        // Tone.Transport.bpm.value = 120; // 可选

        Tone.Transport.start();
        const now = Tone.now() + 0.5;
        const scheduledEvents = [];

        // 获取所有 note 的最小起始时间
        let minTime = Infinity;
        midi.tracks.forEach(track => {
        track.notes.forEach(note => {
            if (note.time < minTime) {
            minTime = note.time;
            }
        });
        });
        console.log("Minimum note time:", minTime);


        // 调度音符
        midi.tracks.forEach((track, trackIndex) => {
        console.log(`Track #${trackIndex} has ${track.notes.length} notes`);
        track.notes.forEach(note => {
            // 在调度前输出每个 note 的时间、音名和持续时长
            console.log(`Note: ${note.name}, time: ${note.time}, duration: ${note.duration}, velocity: ${note.velocity}`);
            const evId = Tone.Transport.schedule(time => {
            // 复用全局 sampler
            sampler.triggerAttackRelease(note.name, note.duration, time, note.velocity);
            }, (note.time - minTime) + now);
            scheduledEvents.push(evId);
        });
        });

        midiPlayer = scheduledEvents;
        isPlaying = true;

    } catch (err) {
        console.error("Error playing MIDI:", err);
    }
    }



    // 停止当前所有播放
    function stopMidi() {
      if (midiPlayer) {
        midiPlayer.forEach(id => Tone.Transport.clear(id));
        midiPlayer = null;
      }
      isPlaying = false;
      Tone.Transport.stop();
    }

    // 处理表单提交，保存返回的结果数据，并显示“Show Output”按钮
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const formData = new FormData(form);
      const resultArea = document.getElementById("resultArea");

      document.getElementById("resultArea").innerHTML = "";
      document.getElementById("visualOutputDiv").innerHTML = "";
      resultArea.innerText = "Processing... Please wait...";

      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: "POST",
          body: formData
        });
        const result = await response.json();

        
        if (result.success) {
          // 后端返回的链接数组
          midFiles = result.midFiles || [];  
          pngFiles = result.pngFiles || [];
          pdfFiles = result.pdfFiles || [];
          mp3Files = result.mp3Files || [];

          resultArea.innerHTML = "Generation success!<br>";
          displayVisualOutput(); 

          // 添加一个按钮来显示可视化输出（MID/PNG/PDF）
          // const showBtn = document.createElement("button");
          // showBtn.innerText = "Show Output";
          // showBtn.addEventListener("click", () => displayVisualOutput());
          // resultArea.appendChild(showBtn);
        } else {
          resultArea.innerText = "Error: " + (result.error || "Unknown error");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("resultArea").innerText = "Request failed: " + err;
      }
    });

    // 显示可视化输出（包括 MID 播放按钮、PNG 图片、PDF 链接）
    function displayVisualOutput() {
      const visualOutputDiv = document.getElementById("visualOutputDiv");
      // 先清空旧内容
      visualOutputDiv.innerHTML = "";

      /*
      // 1) 显示所有 MID 文件及其播放按钮
      if (midFiles.length > 0) {
        const midiContainer = document.createElement("div");
        midiContainer.style.marginBottom = "20px";
        midFiles.forEach((midUrl, index) => {
          const block = document.createElement("div");
          block.className = "midi-file-block";

          const label = document.createElement("span");
          label.innerText = `MIDI File   `;

          const infoLabel = document.createElement("span");
          infoLabel.innerText = "If you want to listen, please be patient.";

          

          const playBtn = document.createElement("button");
          playBtn.innerText = "Play";
          playBtn.addEventListener("click", () => playMidi(index));

          const stopBtn = document.createElement("button");
          stopBtn.innerText = "Stop";
          stopBtn.addEventListener("click", () => stopMidi());

          block.appendChild(label);
          block.appendChild(infoLabel);
          block.appendChild(playBtn);
          block.appendChild(stopBtn);
          midiContainer.appendChild(block);
        });
        visualOutputDiv.appendChild(midiContainer);
      }

      */

      // 1. 添加 MP3 音频播放器
      if(mp3Files.length > 0){
        const audioElem = document.createElement("audio");
        audioElem.controls = true;
        audioElem.src = mp3Files[0];
        audioElem.style.display = "block";
        audioElem.style.marginTop = "20px";
        audioElem.style.marginBottom = "20px";
        visualOutputDiv.appendChild(audioElem);
      }
    

      // 2) 显示 PNG 图片
      if (pngFiles.length > 0) {
        const container = document.createElement("div");
        container.className = "image-container";
        container.style.display = "none"; // 初始隐藏图片

        // 创建 "Show Images" 按钮（初始状态）
        const toggleImagesBtn = document.createElement("button");
        toggleImagesBtn.innerText = "Show Music Score";
        toggleImagesBtn.className = "pdf-btn";

        // 按钮点击事件 -> 切换图片显示/隐藏
        toggleImagesBtn.addEventListener("click", () => {
            if (container.style.display === "none") {
                container.style.display = "flex"; // 显示图片
                toggleImagesBtn.innerText = "Close"; // 按钮变为 "Close Images"
            } else {
                container.style.display = "none"; // 隐藏图片
                toggleImagesBtn.innerText = "Show Music Score"; // 按钮变为 "Show Images"
            }
        });

        // 生成 PNG 图片（默认隐藏）
        pngFiles.forEach(src => {
            const img = document.createElement("img");
            img.src = src;
            img.alt = "Score Image";
            container.appendChild(img);
        });

        // 添加按钮和图片容器到 visualOutputDiv
        visualOutputDiv.appendChild(toggleImagesBtn);
        visualOutputDiv.appendChild(container);
      }

      // 3) 显示 PDF 文件链接
      if (pdfFiles.length > 0) {
        pdfFiles.forEach((pdfUrl, i) => {
          const pdfLink = document.createElement("a");
          pdfLink.href = pdfUrl;
          pdfLink.target = "_blank";
          pdfLink.innerText = `Open PDF`;
          pdfLink.classList.add("pdf-btn");
          pdfLink.style.display = "block";
          pdfLink.style.marginBottom = "50px";
          visualOutputDiv.appendChild(pdfLink);
        });
      }
    }
  </script>
</body>
</html>