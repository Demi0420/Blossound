<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Generation Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tone.js & MIDI解析库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .image-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      overflow-x: auto;
      padding: 10px;
    }
    .image-container img {
      width: 400px;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    }
    .midi-file-block {
      margin-bottom: 10px;
    }
    .midi-file-block button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Music Generation from Image</h1>
  
  <form id="uploadForm" method="post" action="/upload" enctype="multipart/form-data">
    <!-- 表单元素 -->
    <div>
      <label for="file">Select an image file:</label>
      <input type="file" name="file" id="file" required>
    </div>
    <div>
      <label for="length">Length (measures):</label>
      <input type="number" name="length" id="length" value="24" min="8">
    </div>
    <div>
      <label for="method">Method:</label>
      <select name="method" id="method">
        <option value="dual">dual</option>
        <option value="pattern">pattern</option>
      </select>
    </div>
    <div>
      <label for="pattern_name">Pattern Name:</label>
      <select name="pattern_name" id="pattern_name" disabled>
        <option value="alberti_4_4">None</option>
        <option value="alberti_4_4">alberti_4_4</option>
        <option value="boomchick_4_4">boomchick_4_4</option>
        <option value="waltz_3_4">waltz_3_4</option>
        <option value="arp_up_4_4">arp_up_4_4</option>
        <option value="ostinato_16">ostinato_16</option>
      </select>
    </div>
    <div>
      <label for="left_program_index">Left Instrument:</label>
      <select name="left_program_index" id="left_program_index"></select>
    </div>
    <div>
      <label for="right_program_index">Right Instrument:</label>
      <select name="right_program_index" id="right_program_index"></select>
    </div>
    <button type="submit">Upload & Generate</button>
  </form>
  
  <!-- 用于显示生成成功或错误信息 -->
  <div id="resultArea" style="margin-top:20px; color:blue;"></div>

  <!-- 用于显示可视化输出 -->
  <div id="visualOutputDiv" style="margin-top:20px;"></div>
  
  <script>
    // 全局变量
    let midFiles = [];  // 存放 .mid 文件 URL（后端返回）
    let pngFiles = [];  // 存放 PNG 图片 URL
    let pdfFiles = [];  // 存放 PDF 文件 URL

    // Tone.js 调度用
    let midiPlayer = null;  // 当前调度的事件 ID 数组
    let isPlaying = false;   // 当前是否正在播放 MIDI

    // const BACKEND_URL = "http://localhost:8080";
    const BACKEND_URL = "https://blossound-production.up.railway.app";

    // 乐器映射表
    const instrumentDict = {
      "Acoustic Grand Piano": 0,
      "Bright Acoustic Piano": 1,
      "Electric Grand Piano": 2,
      "Honky-tonk Piano": 3,
      "Electric Piano 1": 4,
      "Electric Piano 2": 5,
      "Harpsichord": 6,
      "Clavinet": 7,
      "Celesta": 8,
      "Glockenspiel": 9,
      "Music Box": 10,
      "Vibraphone": 11,
      "Marimba": 12,
      "Xylophone": 13,
      "Tubular Bells": 14,
      "Dulcimer": 15,
      "Drawbar Organ": 16,
      "Percussive Organ": 17,
      "Rock Organ": 18,
      "Church Organ": 19,
      "Reed Organ": 20,
      "Accordion": 21,
      "Harmonica": 22,
      "Tango Accordion": 23,
      "Acoustic Guitar (nylon)": 24,
      "Acoustic Guitar (steel)": 25,
      "Electric Guitar (jazz)": 26,
      "Electric Guitar (clean)": 27,
      "Electric Guitar (muted)": 28,
      "Overdriven Guitar": 29,
      "Distortion Guitar": 30,
      "Guitar Harmonics": 31,
      "Acoustic Bass": 32,
      "Electric Bass (finger)": 33,
      "Electric Bass (pick)": 34,
      "Fretless Bass": 35,
      "Slap Bass 1": 36,
      "Slap Bass 2": 37,
      "Synth Bass 1": 38,
      "Synth Bass 2": 39,
      "Violin": 40,
      "Viola": 41,
      "Cello": 42,
      "Contrabass": 43,
      "Tremolo Strings": 44,
      "Pizzicato Strings": 45,
      "Orchestral Harp": 46,
      "Timpani": 47,
      "String Ensemble 1": 48,
      "String Ensemble 2": 49,
      "Synth Strings 1": 50,
      "Synth Strings 2": 51,
      "Choir Aahs": 52,
      "Voice Oohs": 53,
      "Synth Choir": 54,
      "Orchestra Hit": 55,
      "Trumpet": 56,
      "Trombone": 57,
      "Tuba": 58,
      "Muted Trumpet": 59,
      "French Horn": 60,
      "Brass Section": 61,
      "Synth Brass 1": 62,
      "Synth Brass 2": 63,
      "Soprano Sax": 64,
      "Alto Sax": 65,
      "Tenor Sax": 66,
      "Baritone Sax": 67,
      "Oboe": 68,
      "English Horn": 69,
      "Bassoon": 70,
      "Clarinet": 71,
      "Piccolo": 72,
      "Flute": 73,
      "Recorder": 74,
      "Pan Flute": 75,
      "Blown bottle": 76,
      "Shakuhachi": 77,
      "Whistle": 78,
      "Ocarina": 79,
      "Lead 1 (square)": 80,
      "Lead 2 (sawtooth)": 81,
      "Lead 3 (calliope)": 82,
      "Lead 4 (chiff)": 83,
      "Lead 5 (charang)": 84,
      "Lead 6 (voice)": 85,
      "Lead 7 (fifths)": 86,
      "Lead 8 (bass + lead)": 87,
      "Pad 1 (new age)": 88,
      "Pad 2 (warm)": 89,
      "Pad 3 (polysynth)": 90,
      "Pad 4 (choir)": 91,
      "Pad 5 (bowed)": 92,
      "Pad 6 (metallic)": 93,
      "Pad 7 (halo)": 94,
      "Pad 8 (sweep)": 95,
      "FX 1 (rain)": 96,
      "FX 2 (soundtrack)": 97,
      "FX 3 (crystal)": 98,
      "FX 4 (atmosphere)": 99,
      "FX 5 (brightness)": 100,
      "FX 6 (goblins)": 101,
      "FX 7 (echoes)": 102,
      "FX 8 (sci-fi)": 103,
      "Sitar": 104,
      "Banjo": 105,
      "Shamisen": 106,
      "Koto": 107,
      "Kalimba": 108,
      "Bagpipe": 109,
      "Fiddle": 110,
      "Shanai": 111,
      "Tinkle Bell": 112,
      "Agogo": 113,
      "Steel Drums": 114,
      "Woodblock": 115,
      "Taiko Drum": 116,
      "Melodic Tom": 117,
      "Synth Drum": 118,
      "Reverse Cymbal": 119,
      "Guitar Fret Noise": 120,
      "Breath Noise": 121,
      "Seashore": 122,
      "Bird Tweet": 123,
      "Telephone Ring": 124,
      "Helicopter": 125,
      "Applause": 126,
      "Gunshot": 127
    };

    let sampler = null;
    let samplerLoaded = false;

    async function initSampler() {
        // 解锁音频上下文（需用户交互，如果此时还没有，可以在第一次点击时调用）
        await Tone.start();
        console.log("AudioContext unlocked.");

        // 创建 Sampler 一次
        sampler = new Tone.Sampler(
        {
            "A0": "A0.mp3",
            "C1": "C1.mp3",
            "D#1": "Ds1.mp3",
            "F#1": "Fs1.mp3",
            "A1": "A1.mp3",
            "C2": "C2.mp3",
            "D#2": "Ds2.mp3",
            "F#2": "Fs2.mp3",
            "A2": "A2.mp3",
            "C3": "C3.mp3",
            "D#3": "Ds3.mp3",
            "F#3": "Fs3.mp3",
            "A3": "A3.mp3",
            "C4": "C4.mp3",
            "D#4": "Ds4.mp3",
            "F#4": "Fs4.mp3",
            "A4": "A4.mp3",
            "C5": "C5.mp3",
            "D#5": "Ds5.mp3",
            "F#5": "Fs5.mp3",
            "A5": "A5.mp3",
            "C6": "C6.mp3",
            "D#6": "Ds6.mp3",
            "F#6": "Fs6.mp3",
            "A6": "A6.mp3",
            "C7": "C7.mp3",
            "D#7": "Ds7.mp3",
            "F#7": "Fs7.mp3",
            "A7": "A7.mp3",
            "C8": "C8.mp3"
        },
        {
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/",
            onload: () => {
            console.log("Global Sampler loaded!");
            samplerLoaded = true;
            }
        }
        ).toDestination();
    }

    // 注册一次性的用户交互事件（点击页面任意位置即可触发 initSampler）
    document.addEventListener('click', initSampler, { once: true });


    // 填充乐器下拉菜单
    function populateInstrumentSelect(selectId, defaultName) {
      const selectElem = document.getElementById(selectId);
      for (const [name, prog] of Object.entries(instrumentDict)) {
        const option = document.createElement("option");
        option.value = prog;
        option.text = name;
        selectElem.appendChild(option);
      }
      // 如果存在默认乐器名，则选中它
      if (instrumentDict[defaultName] !== undefined) {
        selectElem.value = instrumentDict[defaultName];
      }
    }

    // 切换 method 时启用/禁用 pattern_name 下拉菜单
    document.getElementById("method").addEventListener("change", function() {
      const patternSelect = document.getElementById("pattern_name");
      patternSelect.disabled = (this.value !== "pattern");
    });

    // 页面加载时填充乐器选择菜单
    window.addEventListener("DOMContentLoaded", () => {
      populateInstrumentSelect("left_program_index", "Acoustic Bass");
      populateInstrumentSelect("right_program_index", "Acoustic Grand Piano");
    });

    // 播放某个 MID 文件
    async function playMidi(index) {
    // 如果还没加载完 Sampler，直接返回或者提示
    if (!samplerLoaded) {
        console.error("Sampler not loaded yet!");
        return;
    }

    // 如果没URL或者已经在播
    if (!midFiles[index]) {
        console.error("没有对应的 MID 文件 URL");
        return;
    }
    if (isPlaying && midiPlayer) {
        stopMidi(); // 先停止上一次
    }

    try {
        // 拉取并解析 MIDI
        const response = await fetch(midFiles[index]);
        const data = await response.arrayBuffer();
        const midi = new Midi(data);

        // 重置 Transport
        Tone.Transport.cancel();
        Tone.Transport.stop();
        Tone.Transport.position = 0;
        // Tone.Transport.bpm.value = 120; // 可选

        Tone.Transport.start();
        const now = Tone.now() + 0.5;
        const scheduledEvents = [];

        // 获取所有 note 的最小起始时间
        let minTime = Infinity;
        midi.tracks.forEach(track => {
        track.notes.forEach(note => {
            if (note.time < minTime) {
            minTime = note.time;
            }
        });
        });
        console.log("Minimum note time:", minTime);


        // 调度音符
        midi.tracks.forEach((track, trackIndex) => {
        console.log(`Track #${trackIndex} has ${track.notes.length} notes`);
        track.notes.forEach(note => {
            // 在调度前输出每个 note 的时间、音名和持续时长
            console.log(`Note: ${note.name}, time: ${note.time}, duration: ${note.duration}, velocity: ${note.velocity}`);
            const evId = Tone.Transport.schedule(time => {
            // 复用全局 sampler
            sampler.triggerAttackRelease(note.name, note.duration, time, note.velocity);
            }, (note.time - minTime) + now);
            scheduledEvents.push(evId);
        });
        });

        midiPlayer = scheduledEvents;
        isPlaying = true;

    } catch (err) {
        console.error("Error playing MIDI:", err);
    }
    }



    // 停止当前所有播放
    function stopMidi() {
      if (midiPlayer) {
        midiPlayer.forEach(id => Tone.Transport.clear(id));
        midiPlayer = null;
      }
      isPlaying = false;
      Tone.Transport.stop();
    }

    // 处理表单提交，保存返回的结果数据，并显示“Show Output”按钮
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const resultArea = document.getElementById("resultArea");
      resultArea.innerText = "Processing... Please wait...";

      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: "POST",
          body: formData
        });
        const result = await response.json();

        
        if (result.success) {
          // 后端返回的链接数组
          midFiles = result.midFiles || [];  
          pngFiles = result.pngFiles || [];
          pdfFiles = result.pdfFiles || [];
          mp3Files = result.mp3Files || [];

          resultArea.innerHTML = "Generation success!<br>";

          // 添加一个按钮来显示可视化输出（MID/PNG/PDF）
          const showBtn = document.createElement("button");
          showBtn.innerText = "Show Output";
          showBtn.addEventListener("click", () => displayVisualOutput());
          resultArea.appendChild(showBtn);
        } else {
          resultArea.innerText = "Error: " + (result.error || "Unknown error");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("resultArea").innerText = "Request failed: " + err;
      }
    });

    // 显示可视化输出（包括 MID 播放按钮、PNG 图片、PDF 链接）
    function displayVisualOutput() {
      const visualOutputDiv = document.getElementById("visualOutputDiv");
      // 先清空旧内容
      visualOutputDiv.innerHTML = "";

 
      // 1) 显示所有 MID 文件及其播放按钮
      if (midFiles.length > 0) {
        const midiContainer = document.createElement("div");
        midiContainer.style.marginBottom = "20px";
        midFiles.forEach((midUrl, index) => {
          const block = document.createElement("div");
          block.className = "midi-file-block";

          const label = document.createElement("span");
          label.innerText = `MIDI File   `;

          const infoLabel = document.createElement("span");
          infoLabel.innerText = "If you want to listen, please be patient.";

          

          const playBtn = document.createElement("button");
          playBtn.innerText = "Play";
          playBtn.addEventListener("click", () => playMidi(index));

          const stopBtn = document.createElement("button");
          stopBtn.innerText = "Stop";
          stopBtn.addEventListener("click", () => stopMidi());

          block.appendChild(label);
          block.appendChild(infoLabel);
          block.appendChild(playBtn);
          block.appendChild(stopBtn);
          midiContainer.appendChild(block);
        });
        visualOutputDiv.appendChild(midiContainer);
      }


      // 1. 添加 MP3 音频播放器
      if(mp3Files.length > 0){
        const audioElem = document.createElement("audio");
        audioElem.controls = true;
        audioElem.src = mp3Files[0];
        audioElem.style.display = "block";
        visualOutputDiv.appendChild(audioElem);
      }
    

      // 2) 显示 PNG 图片
      if (pngFiles.length > 0) {
        const container = document.createElement("div");
        container.className = "image-container";
        pngFiles.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.alt = "Score Image";
          container.appendChild(img);
        });
        visualOutputDiv.appendChild(container);
      }

      // 3) 显示 PDF 文件链接
      if (pdfFiles.length > 0) {
        pdfFiles.forEach((pdfUrl, i) => {
          const pdfLink = document.createElement("a");
          pdfLink.href = pdfUrl;
          pdfLink.target = "_blank";
          pdfLink.innerText = `Open PDF`;
          pdfLink.style.display = "block";
          pdfLink.style.marginTop = "10px";
          visualOutputDiv.appendChild(pdfLink);
        });
      }
    }
  </script>
</body>
</html>