<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Image to Score</title>
  <style>
    /* 页面全局样式 */
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    /* 按钮样式 */
    .btn {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      background-color: #007BFF;
      color: white;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    /* 图片横向滚动容器 */
    .image-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      overflow-x: auto;
      padding: 10px;
    }
    /* 图片样式：固定宽度、自动高度，圆角和阴影 */
    .image-container img {
      width: 400px;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    }
    /* 音频播放器样式：宽度适应手机 */
    .preview-audio {
      margin-top: 10px;
      width: 90%;
      max-width: 400px;
    }
  </style>
</head>
<h1>Blossound</h1>
  <input type="file" id="imageUpload" accept="image/*" />
  <button id="uploadBtn">Start Convert</button>
  
  <!-- 用于显示处理状态 -->
  <div id="resultSection"></div>
  
  <!-- 按钮区域，初始隐藏 -->
  <div id="buttonSection" style="display: none;">
    <p>Successfully generated, please select which group to display</p>
    <button id="btnSet1">Group 1</button>
    <button id="btnSet2">Group 2</button>
  </div>
  
  <!-- 显示选中结果的区域 -->
  <div id="displaySection"></div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const imageUpload = document.getElementById("imageUpload");
    const resultSection = document.getElementById("resultSection");
    const buttonSection = document.getElementById("buttonSection");
    const displaySection = document.getElementById("displaySection");

    // 后端部署的域名
    const BACKEND_URL = "https://blossound-production.up.railway.app";

    // 全局变量存储返回的文件 URL 数组
    let pngFiles = [];
    let mp3Files = [];

    uploadBtn.addEventListener("click", async () => {
      if (!imageUpload.files[0]) {
        alert("Please select one image first!");
        return;
      }

      // 创建表单数据
      const formData = new FormData();
      formData.append("file", imageUpload.files[0]);

      // 显示“加载中”
      resultSection.innerHTML = "Processing, please wait...";
      buttonSection.style.display = "none";
      displaySection.innerHTML = "";

      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          // 显示成功提示
          resultSection.innerHTML = "Successfully generated!";
          
          // 保存返回的文件 URL 数组
          // 后端返回的字段名为 pngFiles 和 mp3Files，都是数组
          pngFiles = data.pngFiles;
          mp3Files = data.mp3Files;

          // 显示按钮区域
          buttonSection.style.display = "block";
        } else {
          resultSection.innerHTML = "Processing failure" + (data.error || "Please check the back-end log.");
        }
      } catch (error) {
        console.error("Request error", error);
        resultSection.innerHTML = "The request failed. The backend cannot be connected.";
      }
    });



    // 绑定按钮事件
    document.getElementById("btnSet1").addEventListener("click", () => {
      displaySet(0);
    });

    document.getElementById("btnSet2").addEventListener("click", () => {
      displaySet(1);
    });

    // 根据索引显示对应的 PNG 和 MP3 文件
    function displaySet(index) {
      displaySection.innerHTML = ""; // 清空之前的内容

      if (mp3Files[index]) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = mp3Files[index];
        audio.className = "preview-audio";
        // 为了适配 iOS Safari 播放时显示进度条和时间
        audio.setAttribute("playsinline", "true");
        audio.setAttribute("preload", "metadata");
        displaySection.appendChild(audio);
      }

      if (pngFiles[index]) {
        // 判断当前组是否为数组，如果不是则转为数组方便统一处理
        const images = Array.isArray(pngFiles[index]) ? pngFiles[index] : [pngFiles[index]];
        const img = document.createElement("img");
        // 创建图片容器（横向滚动）
        const container = document.createElement("div");
        container.className = "image-container";

        // 遍历每个图片地址，创建 <img> 元素并添加到容器中
        images.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.alt = "Score Image";
          container.appendChild(img);
        });

        displaySection.appendChild(container);
      }
      
    }
  </script>
</body>
</html>