<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Image to Score</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    .preview-image {
      display: flex;
      flex-direction: row; /* 默认横排 */
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }
    .preview-audio {
      margin-top: 10px;
    }
  </style>
</head>
<h1>Blossound</h1>
  <input type="file" id="imageUpload" accept="image/*" />
  <button id="uploadBtn">Start Convert</button>
  
  <!-- 用于显示处理状态 -->
  <div id="resultSection"></div>
  
  <!-- 按钮区域，初始隐藏 -->
  <div id="buttonSection" style="display: none;">
    <p>已成功生成，请选择显示哪一组：</p>
    <button id="btnSet1">第一组</button>
    <button id="btnSet2">第二组</button>
  </div>
  
  <!-- 显示选中结果的区域 -->
  <div id="displaySection"></div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const imageUpload = document.getElementById("imageUpload");
    const resultSection = document.getElementById("resultSection");
    const buttonSection = document.getElementById("buttonSection");
    const displaySection = document.getElementById("displaySection");

    // 后端部署的域名
    const BACKEND_URL = "https://blossound-production.up.railway.app";

    // 全局变量存储返回的文件 URL 数组
    let pngFiles = [];
    let mp3Files = [];

    uploadBtn.addEventListener("click", async () => {
      if (!imageUpload.files[0]) {
        alert("请先选择一张图片！");
        return;
      }

      // 创建表单数据
      const formData = new FormData();
      formData.append("file", imageUpload.files[0]);

      // 显示“加载中”
      resultSection.innerHTML = "正在处理，请稍后...";
      buttonSection.style.display = "none";
      displaySection.innerHTML = "";

      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          // 显示成功提示
          resultSection.innerHTML = "已成功生成！";
          
          // 保存返回的文件 URL 数组
          // 后端返回的字段名为 pngFiles 和 mp3Files，都是数组
          pngFiles = data.pngFiles;
          mp3Files = data.mp3Files;

          // 显示按钮区域
          buttonSection.style.display = "block";
        } else {
          resultSection.innerHTML = "处理失败：" + (data.error || "请查看后端日志");
        }
      } catch (error) {
        console.error("请求错误", error);
        resultSection.innerHTML = "请求失败，无法连接后端。";
      }
    });

    // 绑定按钮事件
    document.getElementById("btnSet1").addEventListener("click", () => {
      displaySet(0);
    });

    document.getElementById("btnSet2").addEventListener("click", () => {
      displaySet(1);
    });

    // 根据索引显示对应的 PNG 和 MP3 文件
    function displaySet(index) {
      displaySection.innerHTML = ""; // 清空之前的内容

      if (pngFiles[index]) {
        const img = document.createElement("img");
        img.src = pngFiles[index];
        img.className = "preview-image";
        displaySection.appendChild(img);
      }
      if (mp3Files[index]) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = mp3Files[index];
        audio.className = "preview-audio";
        displaySection.appendChild(audio);
      }
    }
  </script>
</body>
</html>